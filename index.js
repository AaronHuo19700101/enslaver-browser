"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var _classCallCheck=_interopDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass=_interopDefault(require("@babel/runtime/helpers/createClass")),_defineProperty=_interopDefault(require("@babel/runtime/helpers/defineProperty")),_regeneratorRuntime=_interopDefault(require("@babel/runtime/regenerator")),_asyncToGenerator=_interopDefault(require("@babel/runtime/helpers/asyncToGenerator")),_objectSpread=_interopDefault(require("@babel/runtime/helpers/objectSpread")),_typeof=_interopDefault(require("@babel/runtime/helpers/typeof")),_objectWithoutProperties=_interopDefault(require("@babel/runtime/helpers/objectWithoutProperties")),_toConsumableArray=_interopDefault(require("@babel/runtime/helpers/toConsumableArray")),Uri=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";_classCallCheck(this,t),_defineProperty(this,"origin",""),this.origin=e}return _createClass(t,[{key:"route",get:function(){return{protocol:t.decodeProtocol(this.origin),query:t.decodeQuery(this.origin),hash:t.decodeHash(this.origin)}}}],[{key:"decodeProtocol",value:function(e){var t=decodeURIComponent(e).match(/^(\S+):\/\//i);return t&&t[1]?t[1]:""}},{key:"decodeQuery",value:function(e){var t=decodeURIComponent(e).match(/\?([^#]+)#?/i);if(!t||!t[1])return null;var r=t[1].split("&").reduce(function(e,t){var r=t.split("=");return r[0]&&r[1]&&(e[r[0]]=r[1]),e},{});return Object.keys(r).length?r:{}}},{key:"decodeHash",value:function(e){var t=decodeURIComponent(e).match(/#(\S+)/i);return t&&t[1]?t[1]:""}},{key:"encodeQuery",value:function(o){var i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"?",e=Object.keys(o);return e.length?e.reduce(function(e,t,r){var n=r?"&":i;return"".concat(e).concat(n).concat(t,"=").concat(o[t])},""):""}},{key:"encodeHash",value:function(e){return e?"#".concat(e):""}},{key:"encodeProtocol",value:function(e){return e?"".concat(e,"://"):""}}]),t}(),Http=function(){function t(e){var c=this;_classCallCheck(this,t),_defineProperty(this,"baseURI",""),_defineProperty(this,"baseHeaders",{}),_defineProperty(this,"baseInit",{}),_defineProperty(this,"successAOP",function(e){return e}),_defineProperty(this,"errorAOP",function(e){throw e}),_defineProperty(this,"handleInit",function(e){var t=e.method,r=e.headers,n=void 0===r?{}:r,o=e.body,i=_objectWithoutProperties(e,["method","headers","body"]),s=c.handleHeaders(n),a=o;return"object"!==_typeof(o)||o instanceof FormData||(a=JSON.stringify(o),s.append("Content-Type","application/json")),_objectSpread(o?{method:t,headers:s,body:a}:{method:t,headers:s},c.baseInit,i)}),this.init(e)}var r;return _createClass(t,[{key:"init",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.baseURI,r=void 0===t?this.baseURI:t,n=e.baseHeaders,o=void 0===n?this.baseHeaders:n,i=e.baseInit,s=void 0===i?this.baseInit:i,a=e.errorAOP,c=void 0===a?this.errorAOP:a,u=e.successAOP,h=void 0===u?this.successAOP:u;this.baseURI=r,this.baseHeaders=o,this.baseInit=s,this.errorAOP=c,this.successAOP=h}},{key:"handleURI",value:function(e){return new Uri(e).route.protocol?e:"".concat(this.baseURI).concat(e)}},{key:"handleHeaders",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return new Headers(_objectSpread({},this.baseHeaders,e))}},{key:"handleResponse",value:function(e){var t=e.json();return e.ok?t.catch(function(){return console.warn("请求成功，返回结果不是JSON数据."),{}}):t.then(function(e){throw e})}},{key:"handleRequest",value:(r=_asyncToGenerator(_regeneratorRuntime.mark(function e(t){var r,n,o,i,s,a,c,u,h;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.uri,n=t.method,o=void 0===n?"GET":n,i=t.headers,s=void 0===i?{}:i,a=t.body,c=_objectWithoutProperties(t,["uri","method","headers","body"]),e.next=3,fetch(this.handleURI(r),this.handleInit(_objectSpread({method:o,headers:s,body:a},c)));case 3:return u=e.sent,e.prev=4,e.next=7,this.handleResponse(u);case 7:return h=e.sent,e.abrupt("return",this.successAOP(h));case 11:return e.prev=11,e.t0=e.catch(4),e.abrupt("return",this.errorAOP(e.t0));case 14:case"end":return e.stop()}},e,this,[[4,11]])})),function(e){return r.apply(this,arguments)})},{key:"get",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=t.headers,n=_objectWithoutProperties(t,["headers"]);return this.handleRequest(_objectSpread({method:"GET",uri:e,headers:r},n))}},{key:"delete",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=t.headers,n=_objectWithoutProperties(t,["headers"]);return this.handleRequest(_objectSpread({method:"DELETE",uri:e,headers:r},n))}},{key:"post",value:function(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},n=r.headers,o=_objectWithoutProperties(r,["headers"]);return this.handleRequest(_objectSpread({method:"POST",uri:e,body:t,headers:n},o))}},{key:"patch",value:function(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},n=r.headers,o=_objectWithoutProperties(r,["headers"]);return this.handleRequest(_objectSpread({method:"PATCH",uri:e,body:t,headers:n},o))}},{key:"put",value:function(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},n=r.headers,o=_objectWithoutProperties(r,["headers"]);return this.handleRequest(_objectSpread({method:"PUT",uri:e,body:t,headers:n},o))}}]),t}(),Socket=function(){function r(e){_classCallCheck(this,r),_defineProperty(this,"source",""),_defineProperty(this,"socket",null),_defineProperty(this,"events",{}),_defineProperty(this,"lifecycle",{beforeOpen:function(){},onopen:function(){},onerror:function(){},onmessage:function(){},oncloses:function(){}}),this.init(e)}return _createClass(r,[{key:"init",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.source,r=void 0===t?this.source:t,n=e.lifecycle,o=void 0===n?this.lifecycle:n;this.source=r,this.lifecycle=_objectSpread({},this.lifecycle,o),this.lifecycle.beforeOpen()}},{key:"connect",value:function(e){var t=this;this.init(e),this.socket=new WebSocket(this.source),this.socket.onopen=this.lifecycle.onopen,this.socket.onclose=this.lifecycle.onclose,this.socket.onerror=this.lifecycle.onerror,this.socket.onmessage=function(e){return r.onMessage(t,e)}}},{key:"on",value:function(e,t){var r=2<arguments.length&&void 0!==arguments[2]&&arguments[2];this.events[e]=this.events[e]||[],this.events[e]=r?[t]:_toConsumableArray(this.events[e]).concat([t])}},{key:"off",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;this.events[e]=null!==t?this.events[e].filter(function(e){return e!==t}):[]}},{key:"emit",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=_objectSpread({event:e},t),n=JSON.stringify(r);this.socket.send(n)}},{key:"close",value:function(){var e;(e=this.socket).close.apply(e,arguments)}}],[{key:"onMessage",value:function(e,t){var r=t.data,n=JSON.parse(r);e.lifecycle.onmessage(n);var o=n.event;e.events[o]&&e.events[o].length&&e.events[o].forEach(function(e){return e(n)})}}]),r}();exports.Http=Http,exports.Socket=Socket,exports.Uri=Uri;
